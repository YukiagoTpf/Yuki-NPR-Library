## 什么是PBR

PBR的全称是Physically-Based Rendering，准确地说，PBR其实包括多个方面，比如灯光、材质、着色等。**我们平时说的PBR，什么渲染方程、BRDF之类的，指的是PBR的着色部分，也就是PBS，全称是Physically-Based Shading

> 我们熟知的Lambert、Phong等算法，就是光照着色算法（Shading = 着色，Shader = 着色器）。PBR并不是某一种特指的算法，而是一类算法的统称。只要一种着色算法满足一定的物理规律（能量守恒等），我们就认为它属于PBR算法，反之，则不属于PBR算法。

PBR的作用：比起在传统经验算法中加入一些经验控制参数来控制高光、漫反射等效果，PBR算法中通常会提供**粗糙度、金属度、反射率等具有物理意义的材质参数**来控制渲染效果，而且不同材质的这些参数，可以通过直接在现实中测量获得

## 光辐射理论基础

PBR算法成立的基础，就是所谓的**渲染方程（Rendering Equation）**

$L_0(x,w)=L_e(x,w)+\int{\Omega}f_r(x,w,w_i)L_i(x,w_i)\cos(w_i,n)dw_i$ 

几个关于光的物理概念：

**辐射能量（Radiant Energy）：**光以电磁波或者粒子的形式移动时会携带能量，这个能量被称为辐射能量，单位自然是**焦耳(J)**。

**辐射通量（Radiant Flux）：**辐射通量的物理意义是**单位时间内，某一区域通过的辐射能量**，可以理解为辐射能量对时间的微分，也就是功率。辐射通量的单位是**流明(lm)**，但跟我们熟悉的瓦特是等效的。国际单位制中定义波长为555nm的单色光发出的辐射通量1W=683lm。

**辐射照度（Irradiance）：**辐射照度的物理意义是**单位时间内，单位面积上吸收的辐射能量**。当然，方向光不会照向背面，只有表面法线半球内入射的光线才会对辐射照度有贡献。辐射照度的单位是**勒克斯(lux)**，$lux = \frac {lm} {{m}^{2}}$ ，相当于$\frac {W} {{m}^{2}}$。

**辐射亮度（Radiance）：**辐射亮度物理意义是**单位时间内，单位立体角方向上，单位面积上发出/接受的辐射能量。**辐射亮度的单位是**尼特(nit)**，就手机屏幕亮度那个尼特，$nit = \frac {lm} {sr * {m}^{2}}$ ，相当于 $\frac {W} {sr * {m}^{2}}$ 。这个sr呢，是立体角的单位**球面度**，可以理解为三维的弧度，表示单位球体上的一块面积。

顺带一提， $\frac {lm} {sr}$ 这个单位叫**坎德拉(cd)**，是七种国际基本单位之一，用于表示**发光强度/辐射强度（Radiant Intensity）**

总结
- 辐射能量是光的能量。
- 辐射通量是光的功率。
- 发光强度/辐射强度是针对**光源**的单位，表示物体向某一方向**发光**的功率。特别的，因为不涉及面积，所以通常用来描述点光源
- Irradiance是针对**受光物**的单位，表示的是一个单位面积上被光照射后**吸收**的功率。
- Radiance是同时用于**光源/受光物**的单位，用于光源时，表示单位面积光源向某一方向**发光**的功率，用于受光物时，则表示单位面积物体从某一方向光**接受**到的功率。Radiance通常被用来描述面光源，所以我们的手机屏幕、显示器的亮度单位都是Radiance。
- 上述物理量皆为线性，可以拆分、加减。

## 辐射

辐射通量的完整定义是，单位时间内，通过某一区域的**有效**辐射能量
在光线垂直入射的情况下，有效能量就等于入射能量，而光线与平面不垂直的情况下，乘以法线夹角余弦后才是有效的能量

我们用Φ 表示到达物体的有效辐射通量， Φ0 表示原始的辐射通量， 𝜃 表示法线与光源方向夹角，则有：

$\Phi={\Phi}_{0}*cos\theta$

然后我们再来看看Irradiance，其定义是辐射通量对面积的微分，实际含义为单位时间内，到达单位面积的有效辐射能量。我们用 𝑑𝐴 表示单位面积，𝐸 表示Irradiance，则有：

$E=\frac{d\Phi} {dA}=\frac {d{\Phi}_{0}*cos\theta} {dA}$

通俗的理解就是**照射到某一点的有效功率**

重点在Radiance的定义式只有一个，我们用 𝑑𝜔 表示单位立体角， 𝐿 表示Radiance，有：

$L=\frac{{d}^{2}\Phi} {dA * dA * dw * cos\theta }=\frac {{d}^{2}{\Phi}_{0}*cos\theta} {dA*dw*cos\theta} =\frac{{d}^{2}{\Phi}_{0}} {dAdw}$

注意分母中的 𝑐𝑜𝑠𝜃 ，我们既可以将其理解为 𝑑𝐴𝑐𝑜𝑠𝜃 （单位投影面积），也可以理解为 𝑑𝜔𝑐𝑜𝑠𝜃 （单位投影立体角）

总结一下，Radiance的实际含义是，单位时间内，单位投影立体角方向，单位面积上发出/接受的有效辐射能量，或是单位时间内，单位立体角方向，单位投影面积上发出/接受的有效辐射能量。换成大白话说，**点光源向某一方向发出的功率，或是从某一方向照射到某一点的功率（注意不是有效功率）。**

最后，结合上面两式，可得 𝐸=∫𝐿∗𝑐𝑜𝑠𝜃𝑑𝜔 ，这个式子我们后面会经常用到。

## 理解渲染方程

人眼看到的颜色即是亮度Radiance，这个Radiance既可以直接由光源发出，也可以由物体反射发出。各种直接和间接光源向物体表面发出Radiance，全部到达物体表面后被吸收为Irradiance，随后物体作为反射光源向观察方向发出Radiance到达人眼，最终形成被看到的颜色。

渲染方程就是对上述过程的抽象，来看式子：

$L_0(x,w)=L_e(x,w)+\int{\Omega}f_r(x,w,w_i)L_i(x,w_i)\cos(w_i,n)dw_i$ 

$L_0(x,w)$代表坐标x处发射到观察方向v所对应的单位立体角 𝜔 的Radiance，即最终被我们看到的颜色。

$L_e(x,w)$ 代表坐标x处自发光（Emission）的出射Radiance，不过很少有材质会自发光，因此这一项通常是忽略的。

剩下的式子又叫**反射率方程**，表示了物体表面的入射Irradiance和出射Radiance之间的关系。

$L_0(x,w)=\int{\Omega}f_r(x,w,w_i)L_i(x,w_i)\cos(w_i,n)dw_i$

其中：

${L}_{i}(x,{w}_{i})$ 是从 𝜔𝑖方向入射的Radiance， $\cos {({w}_{i},n)}$ 是入射方向与法线方向的夹角。

剩下的 𝑓𝑟(𝑥,𝜔,𝜔𝑖) 这一项，全名叫**双向反射分布函数（Bidirectional Reflectance Distribution Function，BRDF）。**BRDF是对一类函数的统称，Lambert、Phong、Blinn-Phong等模型都有自己的BRDF。

## 理解BRDF

BRDF的定义式如下：

${f}_{r}(x,w,{w}_{i}) =\frac {{L}_{0}(x,w)} {L_i(x,w_i)cos(w_i,n)dw_i}$

其具体定义为，物体表面入射的Irradiance中，来自入射方向 𝜔𝑖 的部分，有多少会贡献到向 𝜔 方向出射的Radiance中。这里需要注意一点，那就是这个式子的分母的物理意义是**Irradiance中由** 𝜔𝑖 **方向Radiance贡献的部分，而不是Radiance。**

为了方便测量，人们就把BRDF的分母项定义为Irradiance了。定义式中上方的单位是nit，下方的单位是lux，两者一除，最后单位是 $\frac{1} {𝑠𝑟}$ 。放回反射率方程之后，可以保证积分之后的单位是nit，是一个Radiance。

BRDF既有物理的也有非物理的，PBR既然基于物理，那肯定要使用基于物理的BRDF。只有满足以下一些物理原则的的BRDF，才被认为是基于物理的BRDF：

- 非负性： ${f}_{r}(x,w,{w}_{i})>=0$
- 可逆性： ${f}_{r}(x,w,w_i)={f}_{r}(x,w_i,w)$，即调换入射和出射方向，结果相同
- 线性性：可以将入射Radiance拆分，分别求解，再求和，得到同样的结果
- 能量守恒：出射Radiance不会大于入射Radiance

## 镜面反射、漫反射与次表面散射

通常我们认为，光线入射到物体表面，有一部分会被**直接反射**出去，形成镜面反射（Specular）的形式出射，这部分出射能量高度集中在较小的范围内，看上去就是很亮的高光。另一部分光线则是先被物体表面**吸收**，在物体内部逛一圈之后再出射，这部分的出射光线被称为次表面散射（Subsurface Scattering），也叫漫反射（Diffuse）。漫反射会比较均匀地分布在各个方向上。

![](https://pic4.zhimg.com/80/v2-979af8a7c805439024e3b25985095803_1440w.webp)

漫反射和次表面散射**在物理上是一回事**，不过我们通常说的漫反射是认为光线就在同一个像素处出射了，而次表面散射会考虑光线被吸收后进入物体内部并在其他地方出射，看上去有一种通透的效果。

Cook-Torrance BRDF同时包含漫反射与镜面反射，由于基于物理的BRDF都是线性的，我们可以将反射率方程拆成互相独立两部分，分别求解：

$\int  {\Omega}({f}_{diffuse}(x,w,w_{i)}+ f_{specular}(x,w,w_i))L_i(x,w_i)\cos {(w_i,n)}dw_i$
我们先来看看镜面反射部分。

### 微平面模型与镜面反射

所谓微平面模型，就是认为对任意材质的物体表面，可以进一步细分为许多小的理想镜面，这些镜面会将入射光线按照法线-反射方向完美反射。越光滑的平面，小镜面的排列越整齐，出射光线就会越集中，反之，出射光线则会越发散。所有的PBR算法，都是基于微平面模型进行渲染的。

![](https://pic4.zhimg.com/80/v2-ce5f27af70574ddd9f2e587f5ec7df9b_1440w.webp)

由于我们在渲染中，操作的最小单位是像素，因此，人们定义了一个**粗糙度（Roughness）**的概念，用来表示一个像素再往下的微观层面上，镜面排列的整齐程度。粗糙度是一个0~1的float值，粗糙度越高，代表该像素的出射光线越发散，看上去越像漫反射，反之，则代表出射光线越集中于法线-反射方向附近，看上去越像理想镜面反射。
Cook-Torrance BRDF的镜面反射部分长这样：

$f_{specular} = \frac{DFG} {4\cos(w,n)\cos(w_i,n)}$

**法线分布函数D：**像素所包含的微小镜面中有百分之多少法线与像素法线一致，粗糙度越高，这个一致性就会越低，D值越小。

**几何遮蔽函数G：**在微平面模型下，一个像素包含的微小镜面可能会互相遮挡。几何遮蔽函数描述了因为微小镜面互相遮挡而造成出射光线衰减的程度。粗糙度越高，遮蔽程度就会越高，G值越小。

**菲涅尔方程F：**菲涅尔方程描述了反射光线占所有光线的比例，该项不仅与材质的基础反射率有关，还取决于光线与像素法线的夹角。在光线与像素法线垂直的情况下，F值达到最大值。（光线跟法线垂直的时候，已经跟表面平行了，那肯定完全不会被吸收啦）

#### 菲涅尔项

菲涅尔方程本身是比较复杂的，大家平时使用的通常是Fresnel-Schlick的近似方程：

$F_{Schlick} = F_0+(1-F_0)(1-\cos(h,v))^5$

其中h就是我们在Blinn-Phong模型里使用的那个half向量， ℎ=𝑣+𝑙 ，v是观察方向，l是光照方向。这个式子是对的，但他的本来面貌是这样的

$F_{Schlick} = F_0+(F_{90}-F_0)(1-\cos(h,v))^5$

𝐹0 是材质在光线从法线方向入射时的反射率，可以通过查表得到。 𝐹90 是光线从垂直于法线方向入射时的反射率。我们通常会认为 𝐹90=1 ，不过Disney也有一个更准确的做法：

$F_{90} = 0.5+2*roughness*\cos^2(h,v)$



### 漫反射

因为菲涅尔项代表的意义是反射光线占全部光线的比例，那么算出了菲涅尔项，我们便可以用能量守恒算出漫反射部分所占比例
所以漫反射部分所占比例应该是（1-F）
所以完整的Cook-Torrance BRDF如下

$f_{cook-torrance} = \frac {Albedo}{\pi}(1-F)+\frac {DFG}{4\cos(w,n)\cos(w_i,n)}$

###  金属度

根据Disney的观察结果，金属材质在光线入射吸收后就不会出射了**（没有漫反射！）**，其本身的基础颜色会在镜面反射中显现。非金属材质则是通过漫反射显现出基础颜色，镜面反射的是光源颜色。严格来说这两种光照模型是不一样的，但是Disney提出了一个金属度（Metallic-ness）的概念，巧妙地将两种光照模型用同一个式子表达出来了：

- 金属材质的金属度为1，非金属材质金属度为0，金属度在0~1之间时，意思是该像素位置在微平面层面混有杂质（比如金属氧化等等），最终结果会是两种模型按金属度进行Blend。
- 金属材质的漫反射部分应该为0
- 金属材质的镜面反射对于不同波长的光吸收程度不一样，所以金属材质的 𝐹0 就等于其Albedo
- 非金属材质的 𝐹0 都很小，并且对于RGB分量的反射没有差异，可以统一用0.04来近似。这样可以在Shader上把 𝐹0 和Albedo用一个Vector表示。

综上所述，我们可以得出最终版的Cook-Torrance BRDF如下：

$F_{0}= lerp(0.04,Albedo,Metallic)$
𝐹$f_{cook-torrance} = \frac {Albedo}{\pi}(1-F)(1 - Metallic)+\frac {DFG}{4\cos(w,n)\cos(w_i,n)}$
