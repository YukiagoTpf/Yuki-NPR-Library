## Gamma空间与线性空间

1. 显示器的输入颜色值和输出亮度之间呈指数函数关系，指数值称为Gamma，一般为2.2
2. 引入Gamma值的目的是适应人眼对亮度的不均匀感受，牺牲亮部细节来保留更多暗部细节。2.2的Gamma值来源于CRT显示器的电压-亮度响应曲线。
3. 为保证相片在屏幕上的显示效果与现实一致，相机会在生成图片时对记录的亮度做一次0.45次方的处理，0.45次方来源于2.2的倒数
4. 在生成时做过一次0.45次方处理的图片，位于Gamma空间，使用它们时需要手动做一次2.2次方，转换到线性空间，以获取物理正确的亮度/反射率等数值
5. 如果不使用PBR流程，完全可以不关心颜色空间的问题，因为看上去差别不大
6. 要使用PBR流程，则需要将Gamma空间制作的图片都转换到线性空间下使用
7. 只有“颜色图”才需要转换颜色空间，法线图等“数据图”不需要转换
8. 在线性空间下计算光照后，写入Framebuffer前需要做0.45次方操作转回Gamma空间
9. “Gamma校正”一词特指从线性空间转到Gamma空间的操作，也就是0.45次方，2.2次方的理论上是他的逆操作，不过实际使用中这个名词基本是混着用的

## HDR与LDR
想要尽可能多地保留场景中明暗变化的细节，关键在于两点：

1. 允许图片中保留大于1.0的数值，不再截断
2. 在不同曝光度下拍摄多张图片，记录下更大动态范围的亮度信息，合成到一张图上

这就是所谓的**高动态范围(High Dynamic Range, HDR)**成像了。与传统的**低动态范围(Low Dynamic Range, LDR)**图片相比，.hdr格式的图片保存浮点格式的像素颜色，可以较好的保留场景的明暗细节。

虽然图片HDR了，但我们的显示器依然还是LDR的，只能显示[0, 1]的Framebuffer。想要正常在LDR显示器上渲染HDR图片，需要使用**色调映射(Tonemapping)**将颜色再转换回LDR范围。

## Tonemapping

> 这几年，随着拍摄设备、渲染方法和显示设备的发展，HDR慢慢会成为标配。照相机和摄像机可以捕捉到HDR的影响，渲染过程中可以产生HDR的画面。这些内容如果需要显示到LDR的设备上，就需要一个称为tone mapping的过程，把HDR变成LDR。现在高端的显示器和电视也可以直接显示出HDR的内容。然而和LDR不同之处在于，LDR就是一个确定的范围，HDR是一个非常宽广的概念。即便两个都是HDR的，但它们的范围仍可能不同。因此有人把这个称为Variable Dynamic Range（VDR），可变动态范围，因为此H不一定是彼H。所以，即便在一个HDR世界，也仍然需要tone mapping来改变动态范围。

Reinhard Tonemapping（经验） —> Filmic Tonemapping（拟合） —> ACES（通用）

## Color LUT

> 完整的ACES Tonemapping算法需要对每个像素做两次矩阵乘法以及两次多项式运算，如果在全屏后处理中使用，性能浪费较大。目前通行的优化方案是使用**颜色查找表(Look Up Table, LUT)**，将每个像素颜色的计算过程转化为一次贴图采样。Unity中使用的Color LUT长这样：
> ![](https://pic4.zhimg.com/80/v2-d92cd0f0a0c1fb04604adbf15be50b6f_1440w.webp)
> Color LUT的具体使用步骤如下：
> 1. 确定LUT使用的坐标空间，Unity使用的是Log C空间，该空间可以将[0, 59) 范围内的颜色值压缩到[0, 1]
> 2. 选择LUT尺寸size，创建一张 size * (size * size) 大小的2D贴图
> 3. 逐个遍历像素，以uv坐标和尺寸换算到LUT空间坐标，再转换回线性空间颜色
> 4. 对线性空间颜色应用Tonemapping，结果写入像素对应uv处
> 5. 实际需要Tonemapping时，将输入线性空间颜色转换到LUT空间，再转换为uv坐标，采样LUT贴图，采样值作为最终结果
> 6. 也可以使用3D贴图，这样可以省去uv坐标转换的步骤
> 7. 使用Color LUT可以将对颜色的所有后处理全部整合到一起，因为不管多么复杂的计算，在实际应用时都转化成了一次采样。那么除了Tonemapping之外，其他诸如色相色温白平衡饱和度这样的调整统统都可以塞到一起去，这也就是为什么我们看Unity中生成LUT那个Shader里有一大堆参数了。

## 总结

1. Tonemapping的作用是将HDR颜色转换到LDR颜色，并且两者都在线性空间
2. 如果是在线性空间中计算的光照，则需要在写入显示器Framebuffer前，应用0.45次方的Gamma校正，作用是将线性LDR颜色转换到Gamma空间
3. Tonemapping需要先于Gamma校正进行，Gamma校正应该作为所有后处理的最后一步